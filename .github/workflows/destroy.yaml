name: Destroy Digital Twin

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to destroy"
        required: true
        default: dev
        type: choice
        options:
          - dev
          - test
          - prod

jobs:
  destroy:
    name: Destroy ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: eu-central-1
      AWS_DEFAULT_REGION: eu-central-1
      TF_VAR_aws_region: eu-central-1
      AWS_EC2_METADATA_DISABLED: "true"
      AWS_SDK_LOAD_CONFIG: "0"
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      # -------------------------------------------------
      # AWS Credentials via OIDC
      # -------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-destroy
          aws-region: eu-central-1
          audience: sts.amazonaws.com

      - name: Verify AWS creds are active
        shell: bash
        run: |
          set -euo pipefail
          aws sts get-caller-identity

      # -------------------------------------------------
      # Build artifacts required by Terraform (zip files)
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build Lambda ZIP (FastAPI) for destroy evaluation
        shell: bash
        run: |
          set -euo pipefail
          echo "Building FastAPI Lambda zip (required for terraform destroy evaluation)..."

          rm -rf backend/.lambda_build
          mkdir -p backend/.lambda_build

          cp -R backend/lambda-package/. backend/.lambda_build/

          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt -t backend/.lambda_build

          (cd backend/.lambda_build && zip -r ../lambda-deployment.zip .)
          ls -lh backend/lambda-deployment.zip

      - name: Setup Node.js (for stream lambda build)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build Stream Lambda ZIP (Node.js) for destroy evaluation
        shell: bash
        run: |
          set -euo pipefail
          echo "Building Stream Lambda zip (required for terraform destroy evaluation)..."

          cd backend/stream-lambda
          npm ci --omit=dev
          zip -r ../stream-lambda.zip .
          cd -

          ls -lh backend/stream-lambda.zip

      # -------------------------------------------------
      # Terraform
      # -------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        shell: bash
        run: |
          set -euo pipefail
          terraform init -input=false

      - name: Terraform Workspace (select)
        working-directory: terraform
        shell: bash
        run: |
          set -euo pipefail
          ENV="${{ github.event.inputs.environment }}"
          terraform workspace select "$ENV"
          terraform workspace show

      - name: Terraform Plan Destroy (preview)
        working-directory: terraform
        shell: bash
        run: |
          set -euo pipefail
          terraform plan -destroy -out=tfdestroy
          terraform show -json tfdestroy > tfdestroy.json

          echo "Resources planned for deletion:"
          jq -r '
            [.resource_changes[]?
              | select(.change.actions | index("delete"))
              | "\(.type).\(.name)  actions=\(.change.actions|join(","))"
            ] | .[]
          ' tfdestroy.json || true

      - name: Terraform Destroy
        working-directory: terraform
        shell: bash
        run: |
          set -euo pipefail
          terraform destroy -auto-approve

      - name: Destroy Summary
        shell: bash
        run: |
          set -euo pipefail
          echo "âœ… Destroy complete for environment: ${{ github.event.inputs.environment }}"
